package {
    // See: http://go/android-license-faq
    // A large-scale-change added 'default_applicable_licenses' to import
    // all of the 'license_kinds' from "frameworks_base_license"
    // to get the below license kinds:
    //   SPDX-license-identifier-Apache-2.0
    default_applicable_licenses: ["frameworks_base_license"],
}

// A library that simulates framework-all.jar
java_library {
    name: "hoststubgen-test-tiny-framework",
    installable: true,
    host_supported: true,
    srcs: ["tiny-framework/src/**/*.java"],
    static_libs: [
        "hoststubgen-annotations",
    ],
    visibility: ["//frameworks/base/ravenwood/tools/hoststubgen:__subpackages__"],
}

// File that contains the standard command line argumetns to hoststubgen.
// This is only for the prototype. The productionized version is "ravenwood-standard-options".
filegroup {
    name: "hoststubgen-standard-options",
    srcs: [
        "hoststubgen-standard-options.txt",
    ],
    visibility: ["//visibility:private"],
}

tf_hsg_base_options = "@$(location :hoststubgen-standard-options) " +
    "--in-jar $(location :hoststubgen-test-tiny-framework) " +
    "--policy-override-file $(location policy-override-tiny-framework.txt) " +
    "--package-redirect com.unsupported:com.supported " +
    "--gen-keep-all-file $(location hoststubgen_keep_all.txt) " +
    "--gen-input-dump-file $(location hoststubgen_dump.txt) "

tf_hsg_base_options_with_out = tf_hsg_base_options +
    "--out-jar $(location host.jar) "

genrule_defaults {
    name: "tf_hsg_base-defaults",
    tools: [
        "hoststubgen",
        "ravenhelper",
    ],
    srcs: [
        ":hoststubgen-standard-options",
        ":hoststubgen-test-tiny-framework",
        "policy-override-tiny-framework.txt",
    ],
    out: [
        "hoststubgen_keep_all.txt",
        "hoststubgen_dump.txt",
    ],
    visibility: ["//visibility:private"],
}

genrule_defaults {
    name: "tf_hsg_base_with_out-defaults",
    defaults: ["tf_hsg_base-defaults"],
    out: [
        "host.jar",
    ],
}

java_genrule_host {
    name: "hoststubgen-test-tiny-framework-host-base",
    defaults: ["tf_hsg_base_with_out-defaults"],
    cmd: "$(location hoststubgen) " + tf_hsg_base_options_with_out,
}

java_genrule_host {
    name: "hoststubgen-test-tiny-framework-stats",
    defaults: ["tf_hsg_base-defaults"],
    cmd: "$(location ravenhelper) stats " + tf_hsg_base_options +
    "--supported-api-list-file $(location api-stats.csv)",
    out: [
        "api-stats.csv",
    ],
}

java_genrule_host {
    name: "hoststubgen-test-tiny-framework-stats-flatten",
    cmd: "$(location csv-flattener) $(location :hoststubgen-test-tiny-framework-stats{api-stats.csv}) > $(location hoststubgen-test-tiny-framework-stats.txt)",
    tools: ["csv-flattener"],
    srcs: [":hoststubgen-test-tiny-framework-stats{api-stats.csv}"],
    out: ["hoststubgen-test-tiny-framework-stats.txt"],
}

java_genrule_host {
    name: "hoststubgen-test-tiny-framework-host",
    cmd: "cp $(in) $(out)",
    srcs: [":hoststubgen-test-tiny-framework-host-base{host.jar}"],
    out: ["host.jar"],
    visibility: ["//visibility:private"],
}

// Compile the test jar, using 2 rules.
// 1. Build the test against the original framework.
java_library_host {
    name: "hoststubgen-test-tiny-test-lib",
    srcs: ["tiny-test/src/**/*.java"],

    libs: [
        "hoststubgen-test-tiny-framework",
        "hoststubgen-helper-runtime",
    ],
    static_libs: [
        "junit",
        "truth",

        // http://cs/h/googleplex-android/platform/superproject/main/+/main:platform_testing/libraries/annotations/src/android/platform/test/annotations/
        "platform-test-annotations",
    ],
    visibility: ["//visibility:private"],
}

// 2. Link "hoststubgen-test-tiny-test-lib" with necessary runtime dependencies, so it can be
// executed stand-alone.
java_test_host {
    name: "hoststubgen-test-tiny-test",
    test_config: "AndroidTest-host.xml",
    static_libs: [
        "hoststubgen-test-tiny-test-lib",
        "hoststubgen-helper-runtime",
        "hoststubgen-test-tiny-framework-host",
    ],
    test_suites: ["general-tests"],
}

// Dump the original and processed jars as text files.
// We use them in test-and-update-golden.sh.
genrule_defaults {
    name: "hoststubgen-jar-dump-defaults",
    tools: ["dump-jar"],
    cmd: "$(location dump-jar) -s -o $(out) $(in)",
    visibility: ["//visibility:private"],
}

java_genrule_host {
    name: "hoststubgen-test-tiny-framework-orig-dump",
    defaults: ["hoststubgen-jar-dump-defaults"],
    srcs: [
        ":hoststubgen-test-tiny-framework",
    ],
    out: [
        "hoststubgen-test-tiny-framework-orig-dump.txt",
    ],
}

java_genrule_host {
    name: "hoststubgen-test-tiny-framework-host-dump",
    defaults: ["hoststubgen-jar-dump-defaults"],
    srcs: [
        ":hoststubgen-test-tiny-framework-host",
    ],
    out: [
        "hoststubgen-test-tiny-framework-host-dump.txt",
    ],
}

// Generate "PTA" script for tiny-framework.
// The output contains files in the fullpaths, so we use the next
// build rule "hoststubgen-test-tiny-framework-pta-output-normalized" to
// remove the unnecessary prefixes.
genrule {
    name: "hoststubgen-test-tiny-framework-pta-output-orig",
    tools: ["ravenhelper"],
    cmd: "$(location ravenhelper) pta " +
        "--output-script $(out) " +
        "--annotation-allowed-classes-file $(location annotation-allowed-classes-tiny-framework-for-pta-test.txt) " +
        "--policy-override-file $(location policy-override-tiny-framework.txt) " +
        "$(locations tiny-framework/src/**/*.java) ",
    srcs: [
        "policy-override-tiny-framework.txt",
        "annotation-allowed-classes-tiny-framework-for-pta-test.txt",
        "tiny-framework/src/**/*.java",
    ],
    out: [
        "pta-output-orig.sed.txt",
    ],
}

genrule {
    name: "hoststubgen-test-tiny-framework-pta-output-normalized",
    cmd: "sed -e 's!^apply .*/test-tiny-framework/!apply \"!' $(in) > $(out)",
    srcs: [
        ":hoststubgen-test-tiny-framework-pta-output-orig",
    ],
    out: [
        "pta-output.sed.txt",
    ],
}

// Generate "MM" script for tiny-framework.
// The output contains files in the fullpaths, so we use the next
// build rule to remove the unnecessary prefixes.
genrule {
    name: "hoststubgen-test-tiny-framework-mm-output-orig",
    tools: ["ravenhelper"],
    cmd: "$(location ravenhelper) mm " +
        "--output-script $(out) " +
        "$(locations tiny-framework/src/**/*.java) " +
        "< $(location mm-method-list.txt) ",
    srcs: [
        "tiny-framework/src/**/*.java",
        "mm-method-list.txt",
    ],
    out: [
        "mm-output-orig.sed.txt",
    ],
}

genrule {
    name: "hoststubgen-test-tiny-framework-mm-output-normalized",
    cmd: "sed -e 's!^apply .*/test-tiny-framework/!apply \"!' $(in) > $(out)",
    srcs: [
        ":hoststubgen-test-tiny-framework-mm-output-orig",
    ],
    out: [
        "mm-output.sed.txt",
    ],
}

// Compare the dump of the jar files to the golden output.
python_test_host {
    name: "tiny-framework-dump-test",
    srcs: [
        "tiny-framework-dump-test.py",
    ],
    data: [
        "golden-output/*.txt",
        ":hoststubgen-test-tiny-framework-pta-output-normalized",
        ":hoststubgen-test-tiny-framework-mm-output-normalized",
    ],
    java_data: [
        "hoststubgen-test-tiny-framework-orig-dump",
        "hoststubgen-test-tiny-framework-host-dump",
        "hoststubgen-test-tiny-framework-stats-flatten",
    ],
    test_suites: ["general-tests"],
}
